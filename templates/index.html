{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
    <!-- Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary shadow">
                <div class="card-body text-center p-4">
                    <h1 class="display-4 mb-3 text-primary"><i class="fas fa-robot me-3"></i>ANSV Bot</h1>
                    <p class="lead">A Not So Vanilla Twitch Bot with TTS capabilities</p>
                    <div class="mt-3">
                        <a href="/control" class="btn btn-primary me-2"><i class="fas fa-cogs me-2"></i>Bot Control</a>
                        <a href="/stats" class="btn btn-info me-2"><i class="fas fa-chart-bar me-2"></i>Statistics</a>
                        <a href="/logs" class="btn btn-secondary"><i class="fas fa-list-alt me-2"></i>View Logs</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <!-- Bot Status Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-info shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Bot Status</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div id="statusSpinner" class="spinner-border text-info me-3" role="status"></div>
                        <h4 id="botStatusText" class="mb-0 text-secondary">Checking status...</h4>
                    </div>
                    <p id="statusLastUpdated" class="text-muted mt-2 small">Last updated: -</p>
                    <div class="mt-3">
                        <button id="startBotBtn" class="btn btn-success btn-sm me-2" onclick="startBot()">
                            <i class="fas fa-play me-1"></i>Start
                        </button>
                        <button id="stopBotBtn" class="btn btn-danger btn-sm" onclick="stopBot()">
                            <i class="fas fa-stop me-1"></i>Stop
                        </button>
                    </div>
                    <div class="mt-2">
                        <button id="refreshStatusBtn" class="btn btn-outline-secondary btn-sm" onclick="checkBotStatus(); loadChannels();">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Status
                        </button>
                        <button id="reconnectBtn" class="btn btn-outline-info btn-sm ms-2" onclick="reconnectBot()">
                            <i class="fas fa-plug me-1"></i>Force Reconnect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connected Channels Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-success shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-tv me-2"></i>Connected Channels</h5>
                </div>
                <div class="card-body">
                    <div id="channelLoadingSpinner" class="spinner-border text-success mb-3" role="status"></div>
                    <div id="channelsList" class="list-group">
                        <div class="text-center text-muted">Loading channels...</div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <span id="channelCount" class="badge bg-success">0</span> channels connected
                </div>
            </div>
        </div>

        <!-- TTS Activity Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-purple shadow-sm">
                <div class="card-header bg-purple text-white">
                    <h5 class="mb-0"><i class="fas fa-volume-up me-2"></i>TTS Activity</h5>
                </div>
                <div class="card-body">
                    <div id="ttsStats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Today:</span>
                            <span id="ttsTodayCount" class="badge bg-primary">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>This week:</span>
                            <span id="ttsWeekCount" class="badge bg-info">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Total:</span>
                            <span id="ttsTotalCount" class="badge bg-secondary">0</span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/tts-history" class="btn btn-sm btn-outline-purple">View All</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent TTS Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent TTS Messages</h5>
                    <button id="refreshTTSBtn" class="btn btn-sm btn-light" onclick="loadRecentTTS()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="ttsLoadingSpinner" class="text-center my-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading recent TTS messages...</p>
                    </div>
                    <div id="recentTTSTable" class="table-responsive" style="display: none;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Channel</th>
                                    <th>Message</th>
                                    <th>Time</th>
                                    <th>Voice</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentTTSBody">
                                <!-- TTS entries will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noTTSData" class="text-center my-4" style="display: none;">
                        <p class="text-muted">No TTS messages found</p>
                    </div>
                </div>
                <div class="card-footer bg-light text-center">
                    <a href="/tts-history" class="btn btn-outline-primary btn-sm">View All TTS History</a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Info Section -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card border-info shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>System Information</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-microchip me-2"></i>CPU Usage</span>
                            <span id="cpuUsage" class="badge bg-primary">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-memory me-2"></i>Memory Usage</span>
                            <span id="memoryUsage" class="badge bg-primary">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-hdd me-2"></i>Disk Usage</span>
                            <span id="diskUsage" class="badge bg-primary">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock me-2"></i>Uptime</span>
                            <span id="uptime" class="badge bg-primary">Loading...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card border-success shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Bot Statistics</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-comments me-2"></i>Total Messages</span>
                            <span id="totalMessages" class="badge bg-success">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-volume-up me-2"></i>TTS Generated</span>
                            <span id="totalTTS" class="badge bg-success">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-robot me-2"></i>Bot Responses</span>
                            <span id="totalResponses" class="badge bg-success">Loading...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar-alt me-2"></i>Active Since</span>
                            <span id="activeSince" class="badge bg-success">Loading...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-purple {
    background-color: #6f42c1;
}
.border-purple {
    border-color: #6f42c1;
}
.btn-outline-purple {
    color: #6f42c1;
    border-color: #6f42c1;
}
.btn-outline-purple:hover {
    color: #fff;
    background-color: #6f42c1;
    border-color: #6f42c1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all data loading functions
    checkBotStatus();
    loadChannels();
    loadRecentTTS();
    loadSystemInfo();
    loadBotStats();
    
    // Set up refresh intervals
    setInterval(checkBotStatus, 10000);
    setInterval(loadSystemInfo, 30000);
    setInterval(loadRecentTTS, 60000);
});

// Load recent TTS messages
function loadRecentTTS() {
    const loadingSpinner = document.getElementById('ttsLoadingSpinner');
    const ttsTable = document.getElementById('recentTTSTable');
    const noDataMsg = document.getElementById('noTTSData');
    const ttsBody = document.getElementById('recentTTSBody');
    
    loadingSpinner.style.display = 'block';
    ttsTable.style.display = 'none';
    noDataMsg.style.display = 'none';
    
    fetch('/api/recent-tts?limit=5')
        .then(response => response.json())
        .then(data => {
            // Update TTS counters
            document.getElementById('ttsTodayCount').textContent = data.stats.today || 0;
            document.getElementById('ttsWeekCount').textContent = data.stats.week || 0;
            document.getElementById('ttsTotalCount').textContent = data.stats.total || 0;
            
            loadingSpinner.style.display = 'none';
            
            if (data.entries && data.entries.length > 0) {
                ttsTable.style.display = 'block';
                ttsBody.innerHTML = '';
                
                data.entries.forEach(entry => {
                    const row = document.createElement('tr');
                    
                    // Format the timestamp for display
                    const timestamp = entry.timestamp;
                    const formattedTime = formatTimestamp(timestamp);
                    
                    // Truncate message if too long
                    const message = entry.message.length > 100 
                        ? entry.message.substring(0, 100) + '...' 
                        : entry.message;
                    
                    row.innerHTML = `
                        <td><span class="badge bg-secondary">${entry.channel}</span></td>
                        <td>${message}</td>
                        <td><small class="text-muted">${formattedTime}</small></td>
                        <td><span class="badge bg-info">${entry.voice_preset}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="playTTS('${entry.id}', '${entry.channel}', '${entry.timestamp}')">
                                <i class="fas fa-play"></i>
                            </button>
                            <a href="/outputs/${entry.channel}/${entry.channel}-${entry.timestamp}.wav" class="btn btn-sm btn-outline-secondary" download>
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    `;
                    ttsBody.appendChild(row);
                });
            } else {
                noDataMsg.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading TTS data:', error);
            loadingSpinner.style.display = 'none';
            noDataMsg.style.display = 'block';
            noDataMsg.innerHTML = '<p class="text-danger">Error loading TTS data</p>';
        });
}

// Load system information
function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            document.getElementById('cpuUsage').textContent = data.cpu_usage + '%';
            document.getElementById('memoryUsage').textContent = data.memory_usage + '%';
            document.getElementById('diskUsage').textContent = data.disk_usage + '%';
            document.getElementById('uptime').textContent = data.uptime;
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

// Load bot statistics
function loadBotStats() {
    fetch('/api/bot-stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalMessages').textContent = data.total_messages.toLocaleString();
            document.getElementById('totalTTS').textContent = data.total_tts.toLocaleString();
            document.getElementById('totalResponses').textContent = data.total_responses.toLocaleString();
            document.getElementById('activeSince').textContent = data.active_since;
        })
        .catch(error => {
            console.error('Error loading bot stats:', error);
        });
}

// Format timestamp for display
function formatTimestamp(timestamp) {
    // If timestamp is in YYYYMMDD-HHMMSS format, convert to readable format
    if (/^\d{8}-\d{6}$/.test(timestamp)) {
        const year = timestamp.substring(0, 4);
        const month = timestamp.substring(4, 6);
        const day = timestamp.substring(6, 8);
        const hour = timestamp.substring(9, 11);
        const minute = timestamp.substring(11, 13);
        const second = timestamp.substring(13, 15);
        
        return `${month}/${day}/${year} ${hour}:${minute}:${second}`;
    }
    
    // If timestamp is already in ISO format, convert that
    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
        return date.toLocaleString();
    }
    
    // If all else fails, return the original timestamp
    return timestamp;
}

// Re-use the functions from bot_control.js
function checkBotStatus() {
    const statusSpinner = document.getElementById('statusSpinner');
    const statusText = document.getElementById('botStatusText');
    const lastUpdated = document.getElementById('statusLastUpdated');
    const startBtn = document.getElementById('startBotBtn');
    const stopBtn = document.getElementById('stopBotBtn');
    
    if (statusSpinner) statusSpinner.style.display = 'block';
    
    fetch('/api/bot-status')
        .then(response => response.json())
        .then(status => {
            if (status.running) {
                statusText.textContent = 'Bot is Running';
                statusText.className = 'mb-0 text-success';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                statusText.textContent = 'Bot is Stopped';
                statusText.className = 'mb-0 text-danger';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
            
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            
            if (statusSpinner) statusSpinner.style.display = 'none';
        })
        .catch(error => {
            console.error('Error checking bot status:', error);
            statusText.textContent = 'Status Unknown';
            statusText.className = 'mb-0 text-warning';
            
            if (statusSpinner) statusSpinner.style.display = 'none';
        });
}

function loadChannels() {
    const spinner = document.getElementById('channelLoadingSpinner');
    const channelsList = document.getElementById('channelsList');
    const channelCount = document.getElementById('channelCount');
    
    if (spinner) spinner.style.display = 'block';
    
    fetch('/api/channels')
        .then(response => response.json())
        .then(data => {
            if (spinner) spinner.style.display = 'none';
            
            if (channelsList) {
                channelsList.innerHTML = '';
                
                if (data.channels && data.channels.length > 0) {
                    data.channels.forEach(channel => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <span># ${channel}</span>
                            <span class="badge bg-success">Connected</span>
                        `;
                        channelsList.appendChild(item);
                    });
                    
                    if (channelCount) channelCount.textContent = data.channels.length;
                } else {
                    channelsList.innerHTML = '<div class="text-center text-muted p-3">No channels connected</div>';
                    if (channelCount) channelCount.textContent = '0';
                }
            }
        })
        .catch(error => {
            console.error('Error loading channels:', error);
            if (spinner) spinner.style.display = 'none';
            if (channelsList) channelsList.innerHTML = '<div class="text-center text-danger p-3">Error loading channels</div>';
        });
}

function startBot() {
    document.getElementById('startBotBtn').disabled = true;
    document.getElementById('stopBotBtn').disabled = true;
    
    fetch('/start-bot', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Bot started successfully', 'success');
        } else {
            showToast(`Failed to start bot: ${data.message}`, 'error');
        }
        
        checkBotStatus();
    })
    .catch(error => {
        console.error('Error starting bot:', error);
        showToast('Error starting bot', 'error');
        
        document.getElementById('startBotBtn').disabled = false;
        document.getElementById('stopBotBtn').disabled = true;
    });
}

function stopBot() {
    if (confirm('Are you sure you want to stop the bot?')) {
        document.getElementById('startBotBtn').disabled = true;
        document.getElementById('stopBotBtn').disabled = true;
        
        showToast('Stopping bot...', 'info');
        
        fetch('/stop-bot', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Bot stopped successfully', 'success');
            } else {
                showToast(`Failed to stop bot: ${data.message}`, 'error');
            }
            
            checkBotStatus();
        })
        .catch(error => {
            console.error('Error stopping bot:', error);
            showToast('Error stopping bot', 'error');
            
            document.getElementById('startBotBtn').disabled = false;
            document.getElementById('stopBotBtn').disabled = false;
        });
    }
}

// Show toast notifications
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    const toastContainer = document.getElementById('toastContainer');
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();
}
</script>
{% endblock %} 