{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
    <!-- Modern Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="hero-content">
                            <h1 class="hero-title"><i class="fas fa-robot hero-icon"></i>ANSV Bot</h1>
                            <p class="hero-subtitle">A powerful Twitch bot with advanced TTS capabilities and Markov chain learning</p>
                            <div class="hero-actions">
                                <a href="/control" class="btn btn-primary btn-lg me-2 btn-action"><i class="fas fa-cogs me-2"></i>Control Panel</a>
                                <a href="/stats" class="btn btn-info btn-lg me-2 btn-action"><i class="fas fa-brain me-2"></i>Brain Stats</a>
                                <a href="/logs" class="btn btn-secondary btn-lg btn-action"><i class="fas fa-list-alt me-2"></i>View Logs</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 d-none d-md-block">
                        <div class="hero-visual text-center">
                            <i class="fas fa-robot hero-robot-icon"></i>
                            <div class="hero-status">
                                <div class="hero-status-dot" id="heroStatusDot"></div>
                                <span id="heroStatusText">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Dashboard -->
    <div class="row mb-4">
        <!-- Main Status Panel -->
        <div class="col-md-5 mb-3">
            <div class="dashboard-card status-panel">
                <div class="status-panel-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="panel-title"><i class="fas fa-heartbeat me-2"></i>Bot Status</h3>
                        <span class="timestamp text-muted" id="statusLastUpdated">Last updated: -</span>
                    </div>
                </div>
                <div class="status-panel-body">
                    <div class="status-display">
                        <div class="d-flex align-items-center mb-3">
                            <div id="statusSpinner" class="spinner-border text-primary me-3"></div>
                            <div class="status-info">
                                <h2 id="botStatusText" class="status-text">Checking status...</h2>
                                <p class="status-desc">ANSV Bot status is being verified</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-controls">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button id="startBotBtn" class="btn btn-success d-flex align-items-center w-100 justify-content-center btn-control" onclick="startBot()">
                                    <i class="fas fa-play me-2"></i>Start Bot
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button id="stopBotBtn" class="btn btn-danger d-flex align-items-center w-100 justify-content-center btn-control" onclick="stopBot()">
                                    <i class="fas fa-stop me-2"></i>Stop Bot
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="refreshStatusBtn" class="btn btn-outline-secondary d-flex align-items-center w-100 justify-content-center btn-control" onclick="checkBotStatus(); loadChannels();">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh Status
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="reconnectBtn" class="btn btn-outline-primary d-flex align-items-center w-100 justify-content-center btn-control" onclick="reconnectBot()">
                                    <i class="fas fa-plug me-2"></i>Force Reconnect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Stats -->
        <div class="col-md-7 mb-3">
            <div class="row h-100">
                <!-- Connected Channels Card -->
                <div class="col-md-6 mb-3">
                    <div class="dashboard-card stats-card channels-card h-100">
                        <div class="stats-card-icon">
                            <i class="fas fa-tv"></i>
                        </div>
                        <div class="stats-card-content">
                            <h3 class="stats-card-title">Connected Channels</h3>
                            <div class="channel-count-display">
                                <span id="channelCount" class="stats-value">0</span>
                                <span class="stats-label">channels</span>
                            </div>
                            <div id="channelLoadingSpinner" class="spinner-border text-success spinner-sm" role="status"></div>
                            <div id="channelsList" class="channels-list mt-3">
                                <div class="text-muted">Loading channels...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TTS Activity Card -->
                <div class="col-md-6 mb-3">
                    <div class="dashboard-card stats-card tts-card h-100">
                        <div class="stats-card-icon">
                            <i class="fas fa-volume-up"></i>
                        </div>
                        <div class="stats-card-content">
                            <h3 class="stats-card-title">TTS Activity</h3>
                            <div id="ttsStats" class="tts-stats">
                                <div class="stat-row">
                                    <div class="stat-item">
                                        <span class="stat-label">Today</span>
                                        <span id="ttsTodayCount" class="stat-value">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Week</span>
                                        <span id="ttsWeekCount" class="stat-value">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Total</span>
                                        <span id="ttsTotalCount" class="stat-value">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a href="/tts-history" class="btn btn-sm btn-outline-purple">View History</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent TTS Activity Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card activity-panel">
                <div class="activity-panel-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="panel-title"><i class="fas fa-history me-2"></i>Recent TTS Activity</h3>
                        <div class="panel-actions">
                            <button id="refreshTTSBtn" class="btn btn-icon" onclick="loadRecentTTS()" title="Refresh TTS data">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <a href="/tts-history" class="btn btn-sm btn-outline-primary ms-2">View All History</a>
                        </div>
                    </div>
                </div>
                
                <div class="activity-panel-body p-0">
                    <!-- Loading state -->
                    <div id="ttsLoadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Loading recent TTS messages...</p>
                    </div>
                    
                    <!-- TTS messages table -->
                    <div id="recentTTSTable" class="table-responsive" style="display: none;">
                        <table class="table table-hover activity-table mb-0">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 10%;">Channel</th>
                                    <th style="width: 45%;">Message</th>
                                    <th style="width: 15%;">Time</th>
                                    <th style="width: 15%;">Voice</th>
                                    <th class="text-center" style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentTTSBody">
                                <!-- TTS entries will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- No data state -->
                    <div id="noTTSData" class="empty-state" style="display: none;">
                        <div class="empty-state-content">
                            <i class="fas fa-comment-slash empty-state-icon"></i>
                            <h4>No TTS Messages</h4>
                            <p class="text-muted">There are no recent TTS messages to display</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Dashboard Section -->
    <div class="row">
        <!-- System Info Card -->
        <div class="col-md-6 mb-4">
            <div class="dashboard-card metrics-panel">
                <div class="metrics-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="panel-title"><i class="fas fa-server me-2"></i>System Metrics</h3>
                        <span class="refresh-indicator"><i class="fas fa-circle-notch fa-spin me-1"></i>Auto-updating</span>
                    </div>
                </div>
                
                <div class="metrics-body">
                    <div class="metrics-grid">
                        <!-- CPU Metric -->
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">CPU Usage</div>
                                <div id="cpuUsage" class="metric-value">0%</div>
                                <div class="metric-gauge">
                                    <div class="progress">
                                        <div id="cpuBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Memory Metric -->
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Memory Usage</div>
                                <div id="memoryUsage" class="metric-value">0%</div>
                                <div class="metric-gauge">
                                    <div class="progress">
                                        <div id="memoryBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disk Metric -->
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Disk Usage</div>
                                <div id="diskUsage" class="metric-value">0%</div>
                                <div class="metric-gauge">
                                    <div class="progress">
                                        <div id="diskBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Uptime Metric -->
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Uptime</div>
                                <div id="uptime" class="metric-value">-</div>
                                <div class="metric-detail">Server running time</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Stats Card -->
        <div class="col-md-6 mb-4">
            <div class="dashboard-card metrics-panel">
                <div class="metrics-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="panel-title"><i class="fas fa-chart-line me-2"></i>Bot Analytics</h3>
                        <a href="/stats" class="btn btn-sm btn-outline-primary">Detailed Stats</a>
                    </div>
                </div>
                
                <div class="metrics-body">
                    <div class="metrics-grid">
                        <!-- Total Messages -->
                        <div class="metric-card">
                            <div class="metric-icon success-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Messages</div>
                                <div id="totalMessages" class="metric-value">-</div>
                                <div class="metric-detail">Total messages processed</div>
                            </div>
                        </div>
                        
                        <!-- TTS Generated -->
                        <div class="metric-card">
                            <div class="metric-icon purple-icon">
                                <i class="fas fa-volume-up"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">TTS Generated</div>
                                <div id="totalTTS" class="metric-value">-</div>
                                <div class="metric-detail">Total audio clips</div>
                            </div>
                        </div>
                        
                        <!-- Bot Responses -->
                        <div class="metric-card">
                            <div class="metric-icon info-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Bot Responses</div>
                                <div id="totalResponses" class="metric-value">-</div>
                                <div class="metric-detail">Messages sent by bot</div>
                            </div>
                        </div>
                        
                        <!-- Active Since -->
                        <div class="metric-card">
                            <div class="metric-icon warning-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-title">Active Since</div>
                                <div id="activeSince" class="metric-value">-</div>
                                <div class="metric-detail">Bot online duration</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Theme color classes */
.bg-purple {
    background-color: #6f42c1;
}
.border-purple {
    border-color: #6f42c1;
}
.btn-outline-purple {
    color: #6f42c1;
    border-color: #6f42c1;
}
.btn-outline-purple:hover {
    color: #fff;
    background-color: #6f42c1;
    border-color: #6f42c1;
}

/* Hero Section Styling */
.hero-card {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #4a6bdf 100%);
    border-radius: 12px;
    padding: 30px;
    color: white;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.hero-title {
    font-size: 2.8rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.hero-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 20px;
}

.hero-icon {
    margin-right: 15px;
}

.hero-actions {
    margin-top: 20px;
}

.hero-visual {
    padding: 20px;
    position: relative;
}

.hero-robot-icon {
    font-size: 6rem;
    display: block;
    margin-bottom: 15px;
    opacity: 0.9;
}

.hero-status {
    display: inline-flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.2);
    padding: 10px 15px;
    border-radius: 30px;
}

.hero-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dc3545;
    margin-right: 8px;
    display: inline-block;
}

.status-active .hero-status-dot {
    background-color: #28a745;
}

/* Dashboard Cards */
.dashboard-card {
    background-color: var(--bs-body-bg);
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.08);
}

[data-bs-theme="dark"] .dashboard-card {
    border-color: rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.dashboard-card:hover {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

/* Panel Styling */
.status-panel {
    height: 100%;
}

.status-panel-header, .activity-panel-header, .metrics-header {
    padding: 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

[data-bs-theme="dark"] .status-panel-header, 
[data-bs-theme="dark"] .activity-panel-header, 
[data-bs-theme="dark"] .metrics-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.panel-title {
    font-size: 1.35rem;
    font-weight: 600;
    margin: 0;
}

.status-panel-body, .activity-panel-body, .metrics-body {
    padding: 20px;
}

.status-display {
    margin-bottom: 20px;
}

.status-text {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.status-desc {
    color: var(--bs-secondary);
    margin: 5px 0 0 0;
}

.status-controls .row {
    margin-left: -10px;
    margin-right: -10px;
}

.status-controls .col-md-6 {
    padding-left: 10px;
    padding-right: 10px;
}

.btn-control {
    padding: 12px 15px;
    border-radius: 12px;
    transition: all 0.2s ease;
}

.btn-control:hover {
    transform: translateY(-2px);
}

.btn-control i {
    font-size: 1.1rem;
}

.timestamp {
    font-size: 0.85rem;
}

/* Stats Cards */
.stats-card {
    padding: 20px;
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.stats-card-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    border-radius: 12px;
    margin-bottom: 15px;
    color: white;
}

.channels-card .stats-card-icon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.tts-card .stats-card-icon {
    background: linear-gradient(135deg, #6f42c1 0%, #9a55ff 100%);
}

.stats-card-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
}

.channel-count-display {
    display: flex;
    align-items: baseline;
    margin-bottom: 15px;
}

.stats-value {
    font-size: 2rem;
    font-weight: 700;
    margin-right: 10px;
}

.stats-label {
    font-size: 1rem;
    color: var(--bs-secondary);
}

.channels-list {
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.9rem;
}

.channel-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.channel-pill {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
    padding: 6px 12px;
    border-radius: 30px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    transition: all 0.2s ease;
    border: 1px solid rgba(40, 167, 69, 0.2);
}

[data-bs-theme="dark"] .channel-pill {
    background-color: rgba(40, 167, 69, 0.15);
    border-color: rgba(40, 167, 69, 0.3);
}

.channel-pill:hover {
    background-color: rgba(40, 167, 69, 0.2);
    transform: translateY(-2px);
}

.channel-pill i {
    margin-right: 5px;
    font-size: 0.75rem;
}

.channel-empty-state, .channel-error-state {
    text-align: center;
    padding: 15px 0;
}

.channel-empty-state i, .channel-error-state i {
    font-size: 1.5rem;
    margin-bottom: 8px;
    opacity: 0.7;
}

.count-changing {
    animation: pulse 0.6s ease;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* TTS Stats */
.tts-stats {
    margin-bottom: 15px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
}

.stat-item {
    text-align: center;
    flex: 1;
    padding: 10px;
}

.stat-item .stat-label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.stat-item .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-right: 0;
}

/* Activity Panel */
.activity-panel {
    margin-bottom: 20px;
}

.panel-actions {
    display: flex;
    align-items: center;
}

.btn-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    padding: 0;
}

.activity-table thead th {
    background-color: rgba(0, 0, 0, 0.02);
    font-weight: 600;
    padding: 12px 20px;
}

[data-bs-theme="dark"] .activity-table thead th {
    background-color: rgba(255, 255, 255, 0.02);
}

.activity-table tbody td {
    padding: 15px 20px;
    vertical-align: middle;
}

.action-btn {
    width: 38px;
    height: 38px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 3px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
}

[data-bs-theme="dark"] .action-btn:hover {
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 3rem;
    color: var(--bs-secondary);
    opacity: 0.5;
    margin-bottom: 15px;
}

/* Metrics Panels */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.metric-card {
    display: flex;
    align-items: flex-start;
    padding: 15px;
    border-radius: 12px;
    background-color: rgba(0, 0, 0, 0.02);
    transition: all 0.2s ease;
}

[data-bs-theme="dark"] .metric-card {
    background-color: rgba(255, 255, 255, 0.03);
}

.metric-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
}

[data-bs-theme="dark"] .metric-card:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

.metric-icon {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    border-radius: 12px;
    margin-right: 15px;
    color: white;
    background: linear-gradient(135deg, var(--bs-primary) 0%, #4a6bdf 100%);
}

.metric-icon.success-icon {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.metric-icon.warning-icon {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

.metric-icon.info-icon {
    background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
}

.metric-icon.purple-icon {
    background: linear-gradient(135deg, #6f42c1 0%, #9a55ff 100%);
}

.metric-content {
    flex: 1;
}

.metric-title {
    font-size: 0.9rem;
    color: var(--bs-secondary);
    margin-bottom: 5px;
}

.metric-value {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.metric-detail {
    font-size: 0.8rem;
    color: var(--bs-secondary);
}

.metric-gauge {
    margin-top: 10px;
}

.progress {
    height: 6px;
    border-radius: 3px;
    background-color: rgba(0, 0, 0, 0.05);
}

[data-bs-theme="dark"] .progress {
    background-color: rgba(255, 255, 255, 0.05);
}

.refresh-indicator {
    font-size: 0.85rem;
    color: var(--bs-secondary);
}

.spinner-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

/* Responsive Adjustments */
@media (max-width: 767.98px) {
    .hero-title {
        font-size: 2rem;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .hero-actions .btn {
        margin-bottom: 10px;
    }
    
    .panel-title {
        font-size: 1.2rem;
    }
    
    .status-panel-header, .activity-panel-header, .metrics-header {
        padding: 15px;
    }
    
    .status-panel-body, .activity-panel-body, .metrics-body {
        padding: 15px;
    }
    
    .btn-control {
        font-size: 0.9rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all data loading functions
    checkBotStatus();
    loadChannels();
    loadRecentTTS();
    loadSystemInfo();
    loadBotStats();
    
    // Set up refresh intervals
    setInterval(checkBotStatus, 10000);
    setInterval(loadSystemInfo, 30000);
    setInterval(loadRecentTTS, 60000);
});

// Load recent TTS messages
function loadRecentTTS() {
    const loadingSpinner = document.getElementById('ttsLoadingSpinner');
    const ttsTable = document.getElementById('recentTTSTable');
    const noDataMsg = document.getElementById('noTTSData');
    const ttsBody = document.getElementById('recentTTSBody');
    
    loadingSpinner.style.display = 'block';
    ttsTable.style.display = 'none';
    noDataMsg.style.display = 'none';
    
    console.log("Fetching recent TTS data...");
    
    fetch('/api/recent-tts?limit=5')
        .then(response => response.json())
        .then(data => {
            console.log("Received TTS data:", data);
            
            // Update TTS counters if stats are available
            if (data.stats) {
                document.getElementById('ttsTodayCount').textContent = data.stats.today || 0;
                document.getElementById('ttsWeekCount').textContent = data.stats.week || 0;
                document.getElementById('ttsTotalCount').textContent = data.stats.total || 0;
            }
            
            loadingSpinner.style.display = 'none';
            
            // Handle array response format (old API) or object with entries (new API format)
            const entries = Array.isArray(data) ? data : (data.entries || []);
            
            if (entries && entries.length > 0) {
                ttsTable.style.display = 'block';
                ttsBody.innerHTML = '';
                
                entries.forEach(entry => {
                    const row = document.createElement('tr');
                    
                    // Format the timestamp for display
                    const timestamp = entry.timestamp;
                    console.log(`Processing timestamp: ${timestamp}`);
                    const formattedTime = formatTimestamp(timestamp);
                    
                    // Truncate message if too long
                    const message = entry.message.length > 100 
                        ? entry.message.substring(0, 100) + '...' 
                        : entry.message;
                    
                    // Create proper WAV path with encoded timestamp
                    // Handle different timestamp formats to ensure paths are correct
                    let formattedTimestampForUrl = '';
                    
                    // Get filename from file_path if available, otherwise construct it
                    let wavFilePath = '';
                    
                    if (entry.file_path) {
                        // Use the file_path provided by the server
                        wavFilePath = entry.file_path;
                        if (!wavFilePath.startsWith('/static/')) {
                            wavFilePath = `/static/${wavFilePath}`;
                        }
                        // Fix double static issue - remove duplicate static in path if present
                        wavFilePath = wavFilePath.replace('/static/static/', '/static/');
                        console.log(`Using provided file path: ${wavFilePath}`);
                    } else {
                        // Construct the path from timestamp manually
                        
                        // For YYYYMMDD-HHMMSS format (already formatted correctly)
                        if (/^\d{8}-\d{6}$/.test(entry.timestamp)) {
                            formattedTimestampForUrl = entry.timestamp;
                        }
                        // For YYYY-MM-DD HH:MM:SS format
                        else if (/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}$/.test(entry.timestamp)) {
                            const datePart = entry.timestamp.split(' ')[0].replace(/-/g, '');
                            const timePart = entry.timestamp.split(' ')[1].replace(/:/g, '');
                            formattedTimestampForUrl = `${datePart}-${timePart}`;
                        }
                        // For ISO format
                        else if (entry.timestamp.includes('T')) {
                            const date = new Date(entry.timestamp);
                            if (!isNaN(date.getTime())) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                const seconds = String(date.getSeconds()).padStart(2, '0');
                                
                                formattedTimestampForUrl = `${year}${month}${day}-${hours}${minutes}${seconds}`;
                            } else {
                                formattedTimestampForUrl = entry.timestamp;
                            }
                        }
                        // Default to the raw timestamp
                        else {
                            formattedTimestampForUrl = entry.timestamp;
                        }
                        
                        wavFilePath = `/static/outputs/${entry.channel}/${entry.channel}-${formattedTimestampForUrl}.wav`;
                        console.log(`Constructed file path: ${wavFilePath}`);
                    }
                    
                    row.innerHTML = `
                        <td class="text-center"><span class="badge bg-secondary">${entry.channel}</span></td>
                        <td>${message}</td>
                        <td><small class="text-muted">${formattedTime}</small></td>
                        <td><span class="badge bg-info">${entry.voice_preset}</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary action-btn" onclick="playAudio('${wavFilePath}')">
                                <i class="fas fa-play"></i>
                            </button>
                            <a href="${wavFilePath}" class="btn btn-sm btn-outline-secondary action-btn" download>
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    `;
                    ttsBody.appendChild(row);
                });
            } else {
                noDataMsg.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading TTS data:', error);
            loadingSpinner.style.display = 'none';
            noDataMsg.style.display = 'block';
            noDataMsg.innerHTML = '<p class="text-danger">Error loading TTS data</p>';
        });
}

// Load system information with progress bars
function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            // Update CPU usage
            const cpuUsage = document.getElementById('cpuUsage');
            const cpuBar = document.getElementById('cpuBar');
            if (cpuUsage && cpuBar) {
                const cpuValue = parseInt(data.cpu_usage);
                cpuUsage.textContent = data.cpu_usage + '%';
                cpuBar.style.width = cpuValue + '%';
                
                // Adjust color based on usage
                if (cpuValue > 80) {
                    cpuBar.className = 'progress-bar bg-danger';
                } else if (cpuValue > 60) {
                    cpuBar.className = 'progress-bar bg-warning';
                } else {
                    cpuBar.className = 'progress-bar bg-info';
                }
            }
            
            // Update Memory usage
            const memoryUsage = document.getElementById('memoryUsage');
            const memoryBar = document.getElementById('memoryBar');
            if (memoryUsage && memoryBar) {
                const memValue = parseInt(data.memory_usage);
                memoryUsage.textContent = data.memory_usage + '%';
                memoryBar.style.width = memValue + '%';
                
                // Adjust color based on usage
                if (memValue > 80) {
                    memoryBar.className = 'progress-bar bg-danger';
                } else if (memValue > 60) {
                    memoryBar.className = 'progress-bar bg-warning';
                } else {
                    memoryBar.className = 'progress-bar bg-success';
                }
            }
            
            // Update Disk usage
            const diskUsage = document.getElementById('diskUsage');
            const diskBar = document.getElementById('diskBar');
            if (diskUsage && diskBar) {
                const diskValue = parseInt(data.disk_usage);
                diskUsage.textContent = data.disk_usage + '%';
                diskBar.style.width = diskValue + '%';
                
                // Adjust color based on usage
                if (diskValue > 80) {
                    diskBar.className = 'progress-bar bg-danger';
                } else if (diskValue > 60) {
                    diskBar.className = 'progress-bar bg-warning';
                } else {
                    diskBar.className = 'progress-bar bg-primary';
                }
            }
            
            // Update uptime
            const uptime = document.getElementById('uptime');
            if (uptime) {
                uptime.textContent = data.uptime;
            }
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

// Load bot statistics
function loadBotStats() {
    fetch('/api/bot-stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalMessages').textContent = data.total_messages.toLocaleString();
            document.getElementById('totalTTS').textContent = data.total_tts.toLocaleString();
            document.getElementById('totalResponses').textContent = data.total_responses.toLocaleString();
            document.getElementById('activeSince').textContent = data.active_since;
        })
        .catch(error => {
            console.error('Error loading bot stats:', error);
        });
}

// Play audio file function with browser compatibility fixes
function playAudio(src) {
    // Fix double static in path if present
    src = src.replace('/static/static/', '/static/');
    console.log(`Playing audio from: ${src}`);
    
    let originalIcon;
    let playBtn;
    
    try {
        // Get the button that triggered the event (if available)
        playBtn = event ? event.target.closest('button') : null;
        
        if (playBtn) {
            originalIcon = playBtn.innerHTML;
            playBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            playBtn.disabled = true;
        }
        
        // First, check if the file exists by making a HEAD request
        fetch(src, { method: 'HEAD' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`File not found (${response.status})`);
                }
                
                // Create audio element after confirming file exists
                const audio = new Audio();
                
                // Set up event handlers before setting src
                audio.onended = () => {
                    console.log('Audio playback completed');
                    if (playBtn) {
                        playBtn.innerHTML = originalIcon;
                        playBtn.disabled = false;
                    }
                };
                
                audio.onerror = (e) => {
                    console.error('Audio error:', e);
                    if (playBtn) {
                        playBtn.innerHTML = originalIcon;
                        playBtn.disabled = false;
                    }
                    handlePlaybackError('Error loading audio file');
                };
                
                // First, try to load the audio to check it's valid
                audio.src = src;
                
                // Force interaction context for audio playback
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio playback started successfully');
                    }).catch(err => {
                        console.error('Playback failed:', err);
                        
                        // Handle autoplay restrictions by using a visible fallback player
                        if (err.name === 'NotSupportedError' || err.name === 'NotAllowedError') {
                            // Create a modal with audio player
                            const audioPlayerId = 'audio-player-' + Date.now();
                            const modalId = 'modal-' + audioPlayerId;
                            
                            const audioModal = document.createElement('div');
                            audioModal.className = 'modal fade';
                            audioModal.id = modalId;
                            audioModal.setAttribute('tabindex', '-1');
                            audioModal.setAttribute('aria-hidden', 'true');
                            
                            audioModal.innerHTML = `
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Audio Player</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <p>Due to browser restrictions, automatic playback is not allowed.</p>
                                            <p>Use the controls below to play the audio:</p>
                                            <audio controls id="${audioPlayerId}" class="w-100 mt-3">
                                                <source src="${src}" type="audio/wav">
                                                Your browser does not support audio playback.
                                            </audio>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <a href="${src}" download class="btn btn-primary">
                                                <i class="fas fa-download me-2"></i>Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            document.body.appendChild(audioModal);
                            
                            // Reset button state
                            if (playBtn) {
                                playBtn.innerHTML = originalIcon;
                                playBtn.disabled = false;
                            }
                            
                            // Show the modal
                            const modal = new bootstrap.Modal(document.getElementById(modalId));
                            modal.show();
                            
                            // Add listener to clean up modal when hidden
                            document.getElementById(modalId).addEventListener('hidden.bs.modal', function () {
                                document.body.removeChild(audioModal);
                            });
                        } else {
                            handlePlaybackError(err.message);
                        }
                    });
                }
            })
            .catch(err => {
                console.error('Fetch error:', err);
                handlePlaybackError(`File not available: ${err.message}`);
            });
    } catch (err) {
        console.error('Playback setup error:', err);
        if (playBtn) {
            playBtn.innerHTML = originalIcon;
            playBtn.disabled = false;
        }
        handlePlaybackError('Unexpected error');
    }
    
    // Helper function for error handling
    function handlePlaybackError(message) {
        if (playBtn) {
            playBtn.innerHTML = originalIcon;
            playBtn.disabled = false;
        }
        
        // Create a notification for the user
        showToast(`Audio playback error: ${message}`, 'warning');
        
        // Create an error modal with download option
        const modalId = 'error-modal-' + Date.now();
        const errorModal = document.createElement('div');
        errorModal.className = 'modal fade';
        errorModal.id = modalId;
        errorModal.setAttribute('tabindex', '-1');
        errorModal.setAttribute('aria-hidden', 'true');
        
        errorModal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">Audio Playback Error</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <p>There was a problem playing the audio file:</p>
                        <p class="text-danger">${message}</p>
                        <p class="mt-3">Possible reasons:</p>
                        <ul class="text-start">
                            <li>The audio file does not exist at the expected location</li>
                            <li>The file format is not supported by your browser</li>
                            <li>The server could not deliver the file</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="${src}" download class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Try Downloading Instead
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(errorModal);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();
        
        // Add listener to clean up modal when hidden
        document.getElementById(modalId).addEventListener('hidden.bs.modal', function () {
            document.body.removeChild(errorModal);
        });
    }
}

// Format timestamp for display
function formatTimestamp(timestamp) {
    console.log(`Formatting timestamp: ${timestamp}`);
    
    // For timestamps with spaces (e.g., "2025-02-24 21:43:08")
    if (/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}$/.test(timestamp)) {
        const dateParts = timestamp.split(' ');
        const datePieces = dateParts[0].split('-');
        return `${datePieces[1]}/${datePieces[2]}/${datePieces[0]} ${dateParts[1]}`;
    }
    
    // For YYYYMMdd without dash (e.g. 20250302)
    if (/^\d{8}$/.test(timestamp)) {
        const year = timestamp.substring(0, 4);
        const month = timestamp.substring(4, 6);
        const day = timestamp.substring(6, 8);
        return `${month}/${day}/${year}`;
    }
    
    // If timestamp is in YYYYMMDD-HHMMSS format, convert to readable format
    if (/^\d{8}-\d{6}$/.test(timestamp)) {
        const year = timestamp.substring(0, 4);
        const month = timestamp.substring(4, 6);
        const day = timestamp.substring(6, 8);
        const hour = timestamp.substring(9, 11);
        const minute = timestamp.substring(11, 13);
        const second = timestamp.substring(13, 15);
        
        return `${month}/${day}/${year} ${hour}:${minute}:${second}`;
    }
    
    // For a different format sometimes seen: YYYYMMDD-HHMMSS as string
    const regex = /(\d{4})(\d{2})(\d{2})-(\d{2})(\d{2})(\d{2})/;
    const match = timestamp.match(regex);
    if (match) {
        const [_, year, month, day, hour, minute, second] = match;
        return `${month}/${day}/${year} ${hour}:${minute}:${second}`;
    }
    
    // If timestamp is already in ISO format, convert that
    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
        return date.toLocaleDateString() + ' ' + 
               date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    }
    
    // If all else fails, return the original timestamp
    return timestamp;
}

// Enhanced bot status check function for the new UI
function checkBotStatus() {
    const statusSpinner = document.getElementById('statusSpinner');
    const statusText = document.getElementById('botStatusText');
    const statusDesc = document.querySelector('.status-desc');
    const lastUpdated = document.getElementById('statusLastUpdated');
    const startBtn = document.getElementById('startBotBtn');
    const stopBtn = document.getElementById('stopBotBtn');
    const heroStatusDot = document.getElementById('heroStatusDot');
    const heroStatusText = document.getElementById('heroStatusText');
    const heroStatus = document.querySelector('.hero-status');
    
    // Show spinner while checking
    if (statusSpinner) statusSpinner.style.display = 'block';
    
    fetch('/api/bot-status')
        .then(response => response.json())
        .then(status => {
            if (status.running) {
                // Update main status display
                if (statusText) {
                    statusText.textContent = 'Online';
                    statusText.className = 'status-text text-success';
                }
                
                if (statusDesc) {
                    statusDesc.textContent = 'ANSV Bot is running and ready to process messages';
                }
                
                // Update buttons
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                
                // Update hero status indicator
                if (heroStatusDot) heroStatusDot.style.backgroundColor = '#28a745';
                if (heroStatusText) heroStatusText.textContent = 'Online';
                if (heroStatus) heroStatus.classList.add('status-active');
            } else {
                // Update main status display
                if (statusText) {
                    statusText.textContent = 'Offline';
                    statusText.className = 'status-text text-danger';
                }
                
                if (statusDesc) {
                    statusDesc.textContent = 'ANSV Bot is currently stopped';
                }
                
                // Update buttons
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                
                // Update hero status indicator
                if (heroStatusDot) heroStatusDot.style.backgroundColor = '#dc3545';
                if (heroStatusText) heroStatusText.textContent = 'Offline';
                if (heroStatus) heroStatus.classList.remove('status-active');
            }
            
            // Update timestamp
            const now = new Date();
            if (lastUpdated) lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            
            // Hide spinner
            if (statusSpinner) statusSpinner.style.display = 'none';
        })
        .catch(error => {
            console.error('Error checking bot status:', error);
            
            // Update status to unknown
            if (statusText) {
                statusText.textContent = 'Unknown';
                statusText.className = 'status-text text-warning';
            }
            
            if (statusDesc) {
                statusDesc.textContent = 'Unable to determine bot status';
            }
            
            // Update hero status indicator
            if (heroStatusDot) heroStatusDot.style.backgroundColor = '#ffc107';
            if (heroStatusText) heroStatusText.textContent = 'Unknown';
            if (heroStatus) heroStatus.classList.remove('status-active');
            
            // Hide spinner
            if (statusSpinner) statusSpinner.style.display = 'none';
        });
}

function loadChannels() {
    const spinner = document.getElementById('channelLoadingSpinner');
    const channelsList = document.getElementById('channelsList');
    const channelCount = document.getElementById('channelCount');
    
    if (spinner) spinner.style.display = 'inline-block';
    
    fetch('/api/channels')
        .then(response => response.json())
        .then(data => {
            if (spinner) spinner.style.display = 'none';
            
            if (channelsList) {
                channelsList.innerHTML = '';
                
                if (data.channels && data.channels.length > 0) {
                    // Create modern channel list
                    const channelList = document.createElement('div');
                    channelList.className = 'channel-pills';
                    
                    data.channels.forEach(channel => {
                        const pill = document.createElement('div');
                        pill.className = 'channel-pill';
                        pill.innerHTML = `
                            <i class="fas fa-hashtag"></i> ${channel}
                        `;
                        channelList.appendChild(pill);
                    });
                    
                    channelsList.appendChild(channelList);
                    
                    // Update the count with animation
                    if (channelCount) {
                        const oldValue = parseInt(channelCount.textContent) || 0;
                        const newValue = data.channels.length;
                        
                        // Animate count change
                        if (oldValue !== newValue) {
                            channelCount.classList.add('count-changing');
                            setTimeout(() => {
                                channelCount.textContent = newValue;
                                channelCount.classList.remove('count-changing');
                            }, 300);
                        } else {
                            channelCount.textContent = newValue;
                        }
                    }
                } else {
                    // Empty state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'channel-empty-state';
                    emptyState.innerHTML = `
                        <i class="fas fa-broadcast-tower text-muted"></i>
                        <p>No channels connected</p>
                    `;
                    channelsList.appendChild(emptyState);
                    
                    if (channelCount) channelCount.textContent = '0';
                }
            }
        })
        .catch(error => {
            console.error('Error loading channels:', error);
            if (spinner) spinner.style.display = 'none';
            
            // Error state
            if (channelsList) {
                const errorState = document.createElement('div');
                errorState.className = 'channel-error-state';
                errorState.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    <p class="text-danger">Error loading channels</p>
                `;
                channelsList.innerHTML = '';
                channelsList.appendChild(errorState);
            }
        });
}

function startBot() {
    document.getElementById('startBotBtn').disabled = true;
    document.getElementById('stopBotBtn').disabled = true;
    
    fetch('/start-bot', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Bot started successfully', 'success');
        } else {
            showToast(`Failed to start bot: ${data.message}`, 'error');
        }
        
        checkBotStatus();
    })
    .catch(error => {
        console.error('Error starting bot:', error);
        showToast('Error starting bot', 'error');
        
        document.getElementById('startBotBtn').disabled = false;
        document.getElementById('stopBotBtn').disabled = true;
    });
}

function stopBot() {
    if (confirm('Are you sure you want to stop the bot?')) {
        document.getElementById('startBotBtn').disabled = true;
        document.getElementById('stopBotBtn').disabled = true;
        
        showToast('Stopping bot...', 'info');
        
        fetch('/stop-bot', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Bot stopped successfully', 'success');
            } else {
                showToast(`Failed to stop bot: ${data.message}`, 'error');
            }
            
            checkBotStatus();
        })
        .catch(error => {
            console.error('Error stopping bot:', error);
            showToast('Error stopping bot', 'error');
            
            document.getElementById('startBotBtn').disabled = false;
            document.getElementById('stopBotBtn').disabled = false;
        });
    }
}

// Show toast notifications
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    const toastContainer = document.getElementById('toastContainer');
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();
}
</script>
{% endblock %} 