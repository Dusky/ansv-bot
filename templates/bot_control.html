<!DOCTYPE html>

{% extends 'base.html' %}


{% block content %}
<div class="container my-4">
        <div class="row">
    <div class="col-md-12">
      <div class="card border-primary shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="fas fa-robot me-2"></i>Bot Control Panel</h4>
        </div>
        <div class="card-body">
          <!-- Bot Status Card -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5 class="mb-0">Bot Status</h5>
                </div>
                <div class="card-body d-flex align-items-center">
                  <div id="statusContainer" class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status" id="statusSpinner">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                      <h3 class="mb-0" id="botStatusText">Checking status...</h3>
                      <small class="text-muted" id="statusLastUpdated">Last updated: Just now</small>
                    </div>
            </div>
        </div>
    </div>
</div>

            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5 class="mb-0">Runtime Options</h5>
    </div>
    <div class="card-body">
                  <form id="botOptionsForm" method="POST" action="{{ url_for('start_bot') }}">
                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="enable_tts" name="enable_tts" {{ 'checked' if enable_tts else '' }}>
                      <label class="form-check-label" for="enable_tts">Enable Text-to-Speech</label>
        </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button type="button" id="startBotBtn" class="btn btn-success" {{ 'disabled' if bot_status.running else '' }}>
                        <i class="fas fa-play me-2"></i>Start Bot
                      </button>
                      <button type="button" id="stopBotBtn" class="btn btn-danger" {{ 'disabled' if not bot_status.running else '' }}>
                        <i class="fas fa-stop me-2"></i>Stop Bot
        </button>
                    </div>
                  </form>
                  <div id="botStartError" class="alert alert-danger mt-3" style="display: none; white-space: pre-wrap;"></div>
                </div>
              </div>
    </div>
</div>

          <!-- Bot Channels -->
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Connected Channels</h5>
                  <button id="refreshChannelsBtn" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                  </button>
    </div>
    <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Channel</th>
                          <th>Status</th>
                          <th>TTS</th>
                          <th>Messages Sent</th>
                          <th>Last Activity</th>
                          <th>Actions</th>
                </tr>
            </thead>
                      <tbody id="channelsTableBody">
                        <tr>
                          <td colspan="6" class="text-center">Loading channels...</td>
                        </tr>
            </tbody>
        </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
</div>

<script>
// Initialize Socket.IO connection
const socketio = io();

// Check bot status periodically
function checkBotStatus() {
  fetch('/api/bot-status')
    .then(response => response.json())
    .then(data => {
      const statusSpinner = document.getElementById('statusSpinner');
      const botStatusText = document.getElementById('botStatusText');
      const statusLastUpdated = document.getElementById('statusLastUpdated');
      const startBotBtn = document.getElementById('startBotBtn');
      const stopBotBtn = document.getElementById('stopBotBtn');
      
      // Update the timestamp
      statusLastUpdated.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      
      // Update status display
      if (data.running) {
        botStatusText.textContent = 'Running';
        botStatusText.className = 'mb-0 text-success';
        startBotBtn.disabled = true;
        stopBotBtn.disabled = false;
      } else {
        botStatusText.textContent = 'Stopped';
        botStatusText.className = 'mb-0 text-danger';
        startBotBtn.disabled = false;
        stopBotBtn.disabled = true;
      }
      
      // Hide spinner
      statusSpinner.style.display = 'none';
      
      // Reflect TTS status
      const enableTtsCheckbox = document.getElementById('enable_tts');
      if (enableTtsCheckbox && data.tts_enabled !== undefined) {
        enableTtsCheckbox.checked = data.tts_enabled;
      }
    })
    .catch(error => {
      console.error('Error checking bot status:', error);
      document.getElementById('botStatusText').textContent = 'Error';
      document.getElementById('botStatusText').className = 'mb-0 text-warning';
      document.getElementById('statusSpinner').style.display = 'none';
    });
}

// Start the bot
document.getElementById('startBotBtn').addEventListener('click', function() {
  // Show loading state
  this.disabled = true;
  this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Starting...';
  
  // Get TTS setting
  const enableTts = document.getElementById('enable_tts').checked;
  
  fetch('/start_bot', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `enable_tts=${enableTts ? 'on' : 'off'}`
  })
  .then(response => {
    if (!response.ok) throw new Error('Failed to start bot');
    return response.text();
  })
  .then(() => {
    showToast('Bot started successfully', 'success');
    setTimeout(checkBotStatus, 2000); // Check status after a delay
    loadChannels(); // Refresh channel list
  })
  .catch(error => {
    console.error('Error starting bot:', error);
    showToast('Failed to start bot', 'error');
    this.disabled = false;
    this.innerHTML = '<i class="fas fa-play me-2"></i>Start Bot';
  });
});

// Stop the bot
document.getElementById('stopBotBtn').addEventListener('click', function() {
  if (confirm('Are you sure you want to stop the bot?')) {
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Stopping...';
    
    fetch('/stop_bot', { method: 'POST' })
      .then(response => {
        if (!response.ok) throw new Error('Failed to stop bot');
        return response.text();
      })
      .then(() => {
        showToast('Bot stopped successfully', 'success');
        setTimeout(checkBotStatus, 2000); // Check status after a delay
        loadChannels(); // Refresh channel list
      })
      .catch(error => {
        console.error('Error stopping bot:', error);
        showToast('Failed to stop bot', 'error');
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Bot';
      });
  }
});

// Toggle TTS
document.getElementById('enable_tts').addEventListener('change', function() {
  if (document.getElementById('botStatusText').textContent === 'Running') {
    fetch('/toggle_tts', { method: 'POST' })
      .then(response => {
        if (!response.ok) throw new Error('Failed to toggle TTS');
        return response.text();
      })
      .then(() => {
        const status = this.checked ? 'enabled' : 'disabled';
        showToast(`TTS ${status} successfully`, 'success');
      })
      .catch(error => {
        console.error('Error toggling TTS:', error);
        showToast('Failed to toggle TTS', 'error');
        // Revert checkbox state on error
        this.checked = !this.checked;
      });
  }
});

// Refresh channels button
document.getElementById('refreshChannelsBtn').addEventListener('click', function() {
  this.disabled = true;
  loadChannels();
  setTimeout(() => { this.disabled = false; }, 2000);
});

// Check status on page load and regularly
document.addEventListener('DOMContentLoaded', function() {
  checkBotStatus();
  loadChannels();
  
  // Set up refresh intervals
  setInterval(checkBotStatus, 30000); // Check bot status every 30 seconds
  setInterval(loadChannels, 60000);   // Refresh channel list every 60 seconds
});

function loadChannels() {
    const tableBody = document.getElementById('channelsTableBody');
    
    // Show loading state
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading channels...</td></tr>';
    
    // Use the API endpoint with error handling
    fetch('/get-channels')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(channels => {
        if (channels.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No channels connected</td></tr>';
          return;
        }
        
        // Clear table
        tableBody.innerHTML = '';
        
        // Add row for each channel
        channels.forEach(channel => {
          const row = document.createElement('tr');
          
          // Channel name with Twitch link
          const nameCell = document.createElement('td');
          const link = document.createElement('a');
          link.href = `https://twitch.tv/${channel.name}`;
          link.target = '_blank';
          link.textContent = channel.name;
          nameCell.appendChild(link);
          
          // Channel status
          const statusCell = document.createElement('td');
          const statusBadge = document.createElement('span');
          statusBadge.className = `badge ${channel.connected ? 'bg-success' : 'bg-danger'}`;
          statusBadge.textContent = channel.connected ? 'Connected' : 'Disconnected';
          statusCell.appendChild(statusBadge);
          
          // TTS status
          const ttsCell = document.createElement('td');
          const ttsBadge = document.createElement('span');
          ttsBadge.className = `badge ${channel.tts_enabled ? 'bg-success' : 'bg-secondary'}`;
          ttsBadge.textContent = channel.tts_enabled ? 'Enabled' : 'Disabled';
          ttsCell.appendChild(ttsBadge);
          
          // Messages sent
          const messagesCell = document.createElement('td');
          messagesCell.textContent = channel.messages_sent || '0';
          
          // Last activity
          const activityCell = document.createElement('td');
          activityCell.textContent = channel.last_activity || 'Never';
          
          // Actions
          const actionsCell = document.createElement('td');
          const joinBtn = document.createElement('button');
          joinBtn.className = 'btn btn-sm btn-outline-primary me-1';
          joinBtn.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i>Join';
          joinBtn.onclick = () => joinChannel(channel.name);
          
          const leaveBtn = document.createElement('button');
          leaveBtn.className = 'btn btn-sm btn-outline-danger';
          leaveBtn.innerHTML = '<i class="fas fa-sign-out-alt me-1"></i>Leave';
          leaveBtn.onclick = () => leaveChannel(channel.name);
          
          actionsCell.appendChild(joinBtn);
          actionsCell.appendChild(leaveBtn);
          
          // Add all cells to the row
          row.appendChild(nameCell);
          row.appendChild(statusCell);
          row.appendChild(ttsCell);
          row.appendChild(messagesCell);
          row.appendChild(activityCell);
          row.appendChild(actionsCell);
          
          // Add row to table
          tableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error loading channels:', error);
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load channels</td></tr>';
      });
}

function joinChannel(channelName) {
    fetch(`/join-channel/${channelName}`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
        showToast(`Joined channel: ${channelName}`, 'success');
        loadChannels(); // Refresh the channels list
        } else {
        showToast(`Failed to join channel: ${data.message}`, 'error');
        }
    })
    .catch(error => {
      console.error('Error joining channel:', error);
      showToast('Error joining channel', 'error');
    });
}

function leaveChannel(channelName) {
    if (confirm(`Are you sure you want to leave the channel: ${channelName}?`)) {
      fetch(`/leave-channel/${channelName}`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
        if (data.success) {
          showToast(`Left channel: ${channelName}`, 'success');
          loadChannels(); // Refresh the channels list
        } else {
          showToast(`Failed to leave channel: ${data.message}`, 'error');
        }
      })
      .catch(error => {
        console.error('Error leaving channel:', error);
        showToast('Error leaving channel', 'error');
      });
    }
}
</script>
{% endblock %}
